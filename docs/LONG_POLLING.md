# 长轮询优化说明

## 📊 问题分析

### 之前的问题：频繁轮询
```
每10秒请求一次 Telegram API
  ↓
即使没有消息也要请求
  ↓
浪费网络资源和 API 配额
```

**统计**：
- 每小时请求：360 次
- 每天请求：8,640 次
- 大部分请求都是无效的（没有新消息）

## ✅ 解决方案：长轮询（Long Polling）

### 工作原理
```
客户端发送请求（timeout=25）
  ↓
Telegram 服务器等待最多 25 秒
  ↓
如果有新消息 → 立即返回
如果没有消息 → 25 秒后返回
```

### 优势对比

| 模式 | 请求频率 | 响应延迟 | 网络消耗 |
|------|---------|---------|---------|
| 短轮询（之前） | 每10秒 | 0-10秒 | 高 |
| 长轮询（现在） | 有消息才请求 | 0-2秒 | 低 |

**统计**：
- 每小时请求：约 144 次（减少 60%）
- 每天请求：约 3,456 次（减少 60%）
- 响应更快（有消息时立即返回）

## 🎯 配置说明

### 环境变量配置
在 `.env` 文件中添加：
```bash
# 启用长轮询（默认：true）
ENABLE_LONG_POLLING=true

# 检查间隔（长轮询模式下可以设置很短，默认：2秒）
POLLING_INTERVAL=2
```

### 代码配置

在 `telegram_utils.py` 中：
```python
# 长轮询参数
polling_timeout = 25  # Telegram 服务器等待时间
request_timeout = 30  # HTTP 请求超时时间
```

在 `dispatcher.py` 中：
```python
# 启用长轮询
has_messages = self.telegram_utils.check_new_messages(long_polling=True)
```

## 📈 性能对比

### 场景1：无消息时
**短轮询**：
```
0秒  → 请求 → 立即返回（无消息）
10秒 → 请求 → 立即返回（无消息）
20秒 → 请求 → 立即返回（无消息）
...
总请求：6次/分钟
```

**长轮询**：
```
0秒  → 请求 → 25秒后返回（无消息）
27秒 → 请求 → 25秒后返回（无消息）
54秒 → 请求 → 25秒后返回（无消息）
...
总请求：2-3次/分钟
```

### 场景2：有消息时
**短轮询**：
```
用户发送消息
  ↓
等待 0-10 秒（平均5秒）
  ↓
下次轮询检测到
```

**长轮询**：
```
用户发送消息
  ↓
Telegram 立即返回
  ↓
0-2 秒内检测到
```

## 🚀 使用建议

### 1. 常驻程序模式（推荐）
```bash
# 启用长轮询，减少请求
ENABLE_LONG_POLLING=true
POLLING_INTERVAL=2
```

### 2. 快速响应模式
```bash
# 启用长轮询 + 短间隔
ENABLE_LONG_POLLING=true
POLLING_INTERVAL=1
```

### 3. 兼容模式（不推荐）
```bash
# 禁用长轮询（仅用于调试）
ENABLE_LONG_POLLING=false
POLLING_INTERVAL=10
```

## 🔧 技术细节

### Telegram API 参数
```python
params = {
    'offset': last_update_id + 1,  # 从哪个 ID 开始
    'limit': 1,                     # 只检查是否有消息
    'timeout': 25                   # 长轮询超时（秒）
}
```

### 网络稳定性
- ✅ 支持梯子/代理环境
- ✅ 自动重试机制
- ✅ 超时保护（30秒）
- ✅ 连接断开自动恢复

## 📝 日志示例

### 启动日志
```
🚀 Telegram-Claude Dispatcher 启动
📡 长轮询: 启用（减少请求频率）
⏰ 检查间隔: 2秒
```

### 运行日志（无消息）
```
📥 检查 Telegram 消息（长轮询模式）...
   检查耗时: 25.12秒
✅ 没有新消息
```

### 运行日志（有消息）
```
📥 检查 Telegram 消息（长轮询模式）...
   检查耗时: 1.23秒
📬 发现新消息！
```

## ⚠️ 注意事项

1. **超时设置**：长轮询的 `timeout` 不能超过 30 秒（Telegram 限制）
2. **网络稳定性**：梯子环境下可能偶尔超时，会自动重试
3. **检查间隔**：长轮询模式下，`POLLING_INTERVAL` 可以设置很短（1-2秒）

## 🎉 总结

长轮询优化后：
- ✅ 减少 60% 的 API 请求
- ✅ 响应速度更快（0-2秒 vs 0-10秒）
- ✅ 更适合常驻程序
- ✅ 节省网络资源
- ✅ 支持梯子环境

---

**版本**: 3.1.0
**更新日期**: 2026-02-04
**新增功能**: 长轮询优化

