# 架构说明 - 重构版

## 系统架构

### 整体设计（仿照 OpenCrawl 架构 + Sandbox 隔离）

```
┌─────────────────────────────────────────────────────────┐
│                   Telegram Bot                          │
│                  (接收用户消息)                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│              Dispatcher (调度器)                         │
│  - 定时检查 (可配置间隔)                                 │
│  - 消息队列管理                                          │
│  - 进程管理                                              │
│  - 日志记录                                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│           Utils (Telegram 工具模块)                      │
│  - 快速检查新消息 (1-2秒)                                │
│  - 获取消息详情                                          │
│  - 发送消息                                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓ (有新消息时)
┌─────────────────────────────────────────────────────────┐
│         SessionManager (会话管理器) 🆕                   │
│  - 创建独立会话目录                                      │
│  - 生成唯一会话ID                                        │
│  - 跟踪活动会话                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│           MessageProcessor (消息处理器)                  │
│  - 格式化消息                                            │
│  - 调用无头 Claude CLI (Sandbox模式) 🔒                 │
│  - 管理进程生命周期                                      │
│  - 使用独立会话目录                                      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│      无头 Claude CLI (Headless + Sandbox) 🔒            │
│  - 在隔离环境中运行                                      │
│  - 通过 MCP 工具处理消息                                 │
│  - 调用各种服务 (arXiv, 12306, etc.)                    │
│  - 生成回复并发送                                        │
│  - 工作目录: .claude_sessions/session_xxx/              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│             HookHandler (Hook处理器)                     │
│  - 捕获 Claude CLI 输出                                  │
│  - 解析工具调用结果                                      │
│  - 提取关键信息                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                 返回 Telegram                            │
│  - 通过 MCP 工具发送消息                                 │
│  - 支持文本、文件、图片等                                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│         SessionManager (清理会话) 🗑️                    │
│  - 删除会话目录                                          │
│  - 备份日志文件                                          │
│  - 释放资源                                              │
└─────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Dispatcher (dispatcher.py)

**职责：**
- 定时触发检查任务
- 协调各个组件工作
- 管理进程生命周期
- 记录详细的执行日志
- 防止重复运行（进程锁）

**关键特性：**
- 可配置检查间隔（通过环境变量 POLLING_INTERVAL）
- 使用 utils 快速检查，避免不必要的 Claude CLI 启动
- 集成 MessageProcessor 和 HookHandler
- 自动超时保护（180秒）
- 模块化设计，易于扩展

### 2. SessionManager (core/session_manager.py) 🆕

**职责：**
- 为每个请求创建独立的会话目录
- 管理会话的生命周期
- 清理会话资源
- 跟踪活动会话

**关键特性：**
- 生成唯一的会话ID（session_xxx_timestamp）
- 创建独立的会话工作目录
- 自动清理会话资源（保留日志）
- 支持批量清理旧会话
- 提供会话统计信息

**安全优势：**
- 每个请求完全隔离，避免任务间干扰
- 会话目录独立，防止文件冲突
- 自动清理，避免资源泄漏

### 3. MessageProcessor (core/message_processor.py)

**职责：**
- 接收和格式化 Telegram 消息
- 调用无头 Claude CLI 处理消息（Sandbox模式）
- 管理 Claude CLI 进程
- 使用独立会话目录
- 返回处理结果

**关键特性：**
- 格式化消息为 Claude 可理解的提示词
- 使用 subprocess 管理无头进程
- **默认启用 Sandbox 模式（--sandbox）**
- **每个请求使用独立会话目录**
- 支持超时控制
- 捕获标准输出和错误输出
- 自动清理会话资源

**Sandbox 模式：**
- 通过 `--sandbox` 标志启用（默认）
- 可通过环境变量 `ENABLE_SANDBOX=false` 禁用
- 提供额外的安全隔离层

### 4. HookHandler (core/hook_handler.py)

**职责：**
- 解析 Claude CLI 的输出
- 提取工具使用情况
- 识别任务完成状态
- 格式化执行摘要

**关键特性：**
- 正则表达式匹配工具调用
- 提取 chat_id 信息
- 错误检测和报告
- 生成可读的执行摘要

### 5. Utils (utils/telegram_utils.py)

**职责：**
- 直接调用 Telegram Bot API
- 快速检查是否有新消息
- 获取消息详情（包含 chat_id）
- 发送消息到指定聊天

**关键特性：**
- 独立于 MCP，可直接在 Python 中调用
- 维护 last_update_id 状态
- 快速检查（1-2秒完成）
- 支持消息确认机制

### 6. Claude CLI (无头模式 + Sandbox)

**职责：**
- 接收格式化的任务请求
- 通过 MCP 工具处理消息
- 调用各种服务（arXiv、12306等）
- 生成并发送回复

**关键特性：**
- **Sandbox 模式运行（--sandbox，默认启用）**
- **在独立会话目录中工作**
- 自动调用 MCP 工具
- 支持多种服务集成
- 完全隔离的执行环境

## 工作流程

### 正常流程（有新消息 + Sandbox + 会话隔离）

```
1. Dispatcher 定时触发 (可配置间隔)
2. TelegramUtils.check_new_messages() - 快速检查 (1-2秒)
3. 发现新消息
4. TelegramUtils.get_pending_messages() - 获取消息详情（不标记为已读）
5. SessionManager.create_session() - 创建独立会话 🆕
   - 生成唯一会话ID
   - 创建会话专用目录 (.claude_sessions/session_xxx/)
6. MessageProcessor.process_messages() - 调用无头 Claude CLI
   - 使用 --sandbox 标志（默认启用）🔒
   - 在会话目录中工作
7. Claude CLI 在隔离环境中通过 MCP 工具处理消息并发送回复
8. HookHandler.parse_output() - 解析执行结果
9. 如果成功，TelegramUtils.acknowledge_messages() - 确认消息已处理
10. SessionManager.cleanup_session() - 清理会话资源 🗑️
    - 备份日志文件
    - 删除会话目录
11. 进程关闭，等待下次检查
```

### 优化流程（无新消息）

```
1. Dispatcher 定时触发 (可配置间隔)
2. TelegramUtils.check_new_messages() - 快速检查 (1-2秒)
3. 没有新消息
4. 跳过，不启动 Claude CLI
5. 等待下次检查
```

### 错误处理流程

```
1. 如果 Claude CLI 执行失败
2. HookHandler 解析错误信息
3. 消息不被确认（不更新 last_update_id）
4. 下次检查时会重新处理该消息
5. 记录详细错误日志
```

## 设计优势

1. **资源高效** - 没消息时不启动重量级的 Claude CLI
2. **安全隔离** 🔒 - 多层安全保障
   - Sandbox 模式：默认启用，提供额外安全层
   - 会话隔离：每个请求独立会话目录
   - 任务隔离：避免不同请求间相互干扰
3. **职责分离** - 模块化设计，各组件职责清晰
   - Utils: 快速消息检查
   - SessionManager: 会话生命周期管理
   - MessageProcessor: 消息处理和进程管理
   - HookHandler: 输出解析和结果提取
4. **自动清理** 🗑️ - 会话完成后自动清理资源
   - 删除临时文件
   - 备份日志文件
   - 防止资源泄漏
5. **易于扩展** - 模块化架构，可轻松添加新功能
6. **详细日志** - 完整记录每个步骤的执行情况
7. **错误恢复** - 失败的消息会在下次检查时重新处理
8. **可配置** - 通过环境变量配置关键参数
9. **仿照 OpenCrawl** - 采用成熟的架构模式

## 配置说明

### 环境变量（.env 文件）

```bash
# Telegram Bot Token（必需）
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Telegram Chat ID（必需）
TELEGRAM_CHAT_ID=751182377

# Claude CLI 路径（可选，默认为 'claude'）
CLAUDE_CLI_PATH=C:\Users\xxx\AppData\Roaming\npm\claude.cmd

# Sandbox 模式（可选，默认为 'true'，强烈推荐）🔒
ENABLE_SANDBOX=true

# 轮询间隔（秒，可选，默认为 10）
POLLING_INTERVAL=10
```

## 项目结构

```
telegram-claude-dispatcher/
├── dispatcher.py           # 主调度器（重构版 + Sandbox）
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── message_processor.py   # 消息处理器（支持Sandbox和会话隔离）
│   ├── session_manager.py     # 会话管理器 🆕
│   └── hook_handler.py        # Hook处理器
├── utils/                  # 工具模块
│   ├── __init__.py
│   └── telegram_utils.py   # Telegram工具
├── docs/
│   └── ARCHITECTURE.md     # 架构文档
├── .env                    # 环境配置
├── .claude_sessions/       # 会话目录（自动创建和清理）🆕
│   ├── session_xxx_timestamp/  # 独立会话目录
│   └── logs_archive/       # 日志归档
└── dispatcher.log          # 运行日志
```

## 安全特性 🔒

### 1. Sandbox 模式
- **默认启用**：通过 `--sandbox` 标志运行 Claude CLI
- **可配置**：通过 `ENABLE_SANDBOX` 环境变量控制
- **安全隔离**：提供额外的安全保护层

### 2. 会话隔离
- **独立目录**：每个请求使用独立的会话目录
- **唯一ID**：生成唯一的会话标识符
- **自动清理**：任务完成后自动清理资源

### 3. 资源管理
- **自动清理**：会话完成后删除临时文件
- **日志备份**：保留重要日志用于调试
- **防止泄漏**：确保资源正确释放

### 4. 任务隔离
- **无干扰**：不同请求完全隔离
- **无冲突**：避免文件和状态冲突
- **可追踪**：每个会话可独立追踪和调试
```

