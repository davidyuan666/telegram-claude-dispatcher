# 架构说明

## 系统架构

### 整体设计

```
┌─────────────────────────────────────────────────────────┐
│                   Telegram Bot                          │
│                  (接收用户消息)                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│              Dispatcher (调度器)                         │
│  - 定时检查 (每30秒)                                     │
│  - 进程管理                                              │
│  - 日志记录                                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│           Utils (Telegram 工具模块)                      │
│  - 快速检查新消息 (1-2秒)                                │
│  - 获取消息详情                                          │
│  - 发送消息                                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓ (有新消息时)
┌─────────────────────────────────────────────────────────┐
│                 Claude CLI                               │
│  - 通过 MCP 工具处理消息                                 │
│  - 调用各种服务 (arXiv, 12306, etc.)                    │
│  - 生成回复                                              │
└─────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Dispatcher (dispatcher.py)

**职责：**
- 定时触发检查任务
- 管理 Claude CLI 进程生命周期
- 记录详细的执行日志
- 防止重复运行（进程锁）

**关键特性：**
- 每30秒检查一次
- 使用 utils 快速检查，避免不必要的 Claude CLI 启动
- 实时显示执行进度（每10秒）
- 自动超时保护（120秒）

### 2. Utils (utils/telegram_utils.py)

**职责：**
- 直接调用 Telegram Bot API
- 快速检查是否有新消息
- 获取消息详情（包含 chat_id）
- 发送消息到指定聊天

**关键特性：**
- 独立于 MCP，可直接在 Python 中调用
- 维护 last_update_id 状态
- 快速检查（1-2秒完成）

### 3. Claude CLI + MCP

**职责：**
- 接收调度器的任务请求
- 通过 MCP 工具获取和处理消息
- 调用各种服务（arXiv、12306等）
- 生成并发送回复

## 工作流程

### 正常流程（有新消息）

```
1. 调度器定时触发 (30秒)
2. utils.check_new_messages() - 快速检查 (1-2秒)
3. 发现新消息
4. 启动 Claude CLI
5. Claude CLI 通过 MCP 获取消息
6. Claude 处理并生成回复
7. Claude CLI 通过 MCP 发送回复
8. 进程关闭，等待下次检查
```

### 优化流程（无新消息）

```
1. 调度器定时触发 (30秒)
2. utils.check_new_messages() - 快速检查 (1-2秒)
3. 没有新消息
4. 跳过，不启动 Claude CLI
5. 等待下次检查
```

## 设计优势

1. **资源高效** - 没消息时不启动重量级的 Claude CLI
2. **职责分离** - utils 负责快速检查，MCP 负责完整处理
3. **易于扩展** - utils 可被其他 Python 脚本复用
4. **详细日志** - 完整记录每个步骤的执行情况

