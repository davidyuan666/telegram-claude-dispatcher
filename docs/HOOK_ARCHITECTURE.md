# Hook 架构说明

## 概述

Dispatcher 现在使用双 Hook 架构：
- **PreHook**: 消息接收预处理
- **PostHook**: 消息发送后处理

## 架构流程

```
Telegram 消息
    ↓
【PreHook】消息接收预处理
    ├─ 权限检查（白名单/黑名单）
    ├─ 限流控制（防止滥用）
    ├─ 命令路由（/help, /status, /ping）
    └─ 消息增强（添加元数据）
    ↓
Dispatcher 调度
    ↓
Claude CLI 处理
    ↓
【PostHook】消息发送后处理
    ├─ 内容提取（标记模式 + 智能提取）
    ├─ 内容清理（移除多余空行）
    ├─ 内容美化（格式化）
    ├─ 长度检查（截断过长消息）
    └─ 添加时间戳（可选）
    ↓
发送到 Telegram
```

## PreHook 功能

### 1. 权限控制
```python
pre_hook_config = {
    'whitelist': [],      # 白名单用户ID（留空=不启用）
    'blacklist': [],      # 黑名单用户ID
    'rate_limit': 10,     # 每分钟最多请求数
}
```

### 2. 命令路由
支持的命令：
- `/help` - 显示帮助信息
- `/status` - 查看系统状态
- `/ping` - 测试连接

### 3. 限流保护
- 每个用户每分钟最多 10 次请求
- 超过限制自动拦截并提示

### 4. 消息增强
自动添加元数据：
- 处理时间戳
- 用户ID和用户名

## PostHook 功能

### 1. 内容提取
**方法1：标记模式**（优先）
```
===REPLY_START===
回复内容
===REPLY_END===
```

**方法2：智能提取**（备用）
- 自动过滤系统输出
- 提取实际回复内容

### 2. 内容处理
- **清理**: 移除多余空行和特殊字符
- **美化**: 格式化内容（可扩展）
- **截断**: 超过 4000 字符自动截断
- **时间戳**: 可选添加处理时间

### 3. 配置选项
```python
post_hook_config = {
    'max_length': 4000,           # 最大消息长度
    'enable_formatting': True,    # 启用美化
    'add_timestamp': False,       # 添加时间戳
}
```

## 使用示例

### 场景1：普通消息处理
```
用户: "搜索一下2026年的论文"
  ↓ PreHook: 权限检查 ✓, 限流检查 ✓
  ↓ Claude CLI: 调用 arXiv MCP 搜索
  ↓ PostHook: 提取结果，格式化
  ↓ 发送: "找到以下论文..."
```

### 场景2：命令快速响应
```
用户: "/help"
  ↓ PreHook: 识别命令，直接返回帮助信息
  ↓ 跳过 Claude CLI（节省资源）
  ↓ 发送: "📖 帮助信息..."
```

### 场景3：限流保护
```
用户: 连续发送 11 条消息
  ↓ PreHook: 前 10 条通过，第 11 条拦截
  ↓ 发送: "⚠️ 请求过于频繁，请稍后再试"
```

### 场景4：权限拒绝
```
黑名单用户: "帮我查询"
  ↓ PreHook: 检测到黑名单用户
  ↓ 发送: "❌ 您已被禁止使用此服务"
```

## 配置文件位置

配置在 `dispatcher.py` 的 `_init_components()` 方法中：

```python
# PreHook 配置
pre_hook_config = {
    'whitelist': [],      # 添加用户ID启用白名单
    'blacklist': [],      # 添加用户ID屏蔽用户
    'rate_limit': 10,     # 调整限流阈值
}

# PostHook 配置
post_hook_config = {
    'max_length': 4000,
    'enable_formatting': True,
    'add_timestamp': False,
}
```

## 优点总结

### PreHook 优点
1. ✅ **安全性**: 权限控制，防止滥用
2. ✅ **性能**: 命令快速响应，节省资源
3. ✅ **稳定性**: 限流保护，防止过载
4. ✅ **可扩展**: 易于添加新命令和规则

### PostHook 优点
1. ✅ **智能提取**: 双模式提取，容错性强
2. ✅ **内容优化**: 自动清理和美化
3. ✅ **用户体验**: 长度控制，避免消息过长
4. ✅ **灵活配置**: 可根据需求调整

## 版本信息

- **版本**: 3.0.0
- **更新日期**: 2026-02-04
- **新增功能**: PreHook + PostHook 双 Hook 架构

